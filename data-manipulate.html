<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
  <head>
    <title>Data Manipulation and Plot in R</title>
    <meta charset="utf-8" />
    <meta name="author" content="林子堯" />
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link rel="stylesheet" href="my-theme.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Data Manipulation and Plot in R
## tidyr, dplyr and ggplot2
### 林子堯
### 2020/03/28 Sat.

---




# Download: &lt;https://bit.ly/39a7RCI&gt;

.center[
![](figure/qr.ioi.tw.png)
]


```r
# install.packages(tidyverse)
library(tidyverse) # including dplyr, tidyr, &amp; ggplot ...
```

---

# Outline

.Large[
- introduction
- data.frame
- dplyr
- tidyr
- ggplot2
]


---

# Motivation

Data preprocessing takes 50-80% of your time in data analysis

Goal of Data Preprocessing  
- ake data suitable to use with a particular piece of software (i.e. R, - Python)  
- Reveal important information  
- Extract variables to analyze

---

# Hadley Wickham

- The Man Who Revolutionized R
- The Committee of Presidents of Statistical Societies Awards
- [tidyverse](https://www.tidyverse.org/)

![:scale 90%](figure/HadleyWickham-R.jpg)

---

.center[
![](figure/ChartHadley.png)
]

---

.center[
![](figure/package download.png)
]

---

# R packages for data science

.center[
![:scale 90%](figure/tidyverse_data_science.png)
]

---
class: inverse, center, middle

# data.frame


---

# data.frame() create


```r
student &lt;- data.frame(
  ID = LETTERS[1:12], 
  math = round(rnorm(12, 50, 15), 1),
  chinese = seq(4, 92, length.out = 12))
student
```

```
   ID math chinese
1   A 51.7       4
2   B 27.7      12
3   C 40.9      20
4   D 64.7      28
5   E 41.2      36
6   F 12.2      44
7   G 63.3      52
8   H 55.1      60
9   I 36.1      68
10  J 49.9      76
11  K 41.9      84
12  L 70.2      92
```

--- 

# data.frame(): create

load data

```r
ebg &lt;- read.csv("data/001_b_1110_1_1_p1.csv", 
                fileEncoding = "UTF-8")
head(ebg)
```

```
  Trials MarketCondition StockPrice p1Cash p1Stock p1TotalAsset p1Decision
1      1               1        100  10000      10        11000        buy
2      2               1        105   9900      11        11055       sell
3      3               1        105  10005      10        11055        buy
4      4               1        111   9900      11        11121       sell
5      5               1        106  10011      10        11071   no trade
6      6               1        103  10011      10        11041        buy
  p1ChechHistory
1             no
2             no
3            yes
4             no
5            yes
6            yes
```

```r
class(ebg)
```

```
[1] "data.frame"
```

---

# data.frame(): read


```r
# []
ebg[1]
ebg["p1Cash"]

# [,]
ebg[1, 3]
ebg[1:10, 2:3]

# [[]]
ebg[[1]]

# $
ebg$StockPrice
ebg$p1Decision[61:100]
typeof(ebg)
```

---

# data.frame(): update


```r
student$psychology &lt;- rep(c(59, 61), each = 2, times = 3)
student
```

```
   ID math chinese psychology
1   A 51.7       4         59
2   B 27.7      12         59
3   C 40.9      20         61
4   D 64.7      28         61
5   E 41.2      36         59
6   F 12.2      44         59
7   G 63.3      52         61
8   H 55.1      60         61
9   I 36.1      68         59
10  J 49.9      76         59
11  K 41.9      84         61
12  L 70.2      92         61
```


---
class: inverse, center, middle

# dplyr

---

# tibble


```r
# install.packages("nycflights13")
data(flights, package = "nycflights13")
flights
```

```
# A tibble: 336,776 x 19
    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;
 1  2013     1     1      517            515         2      830            819
 2  2013     1     1      533            529         4      850            830
 3  2013     1     1      542            540         2      923            850
 4  2013     1     1      544            545        -1     1004           1022
 5  2013     1     1      554            600        -6      812            837
 6  2013     1     1      554            558        -4      740            728
 7  2013     1     1      555            600        -5      913            854
 8  2013     1     1      557            600        -3      709            723
 9  2013     1     1      557            600        -3      838            846
10  2013     1     1      558            600        -2      753            745
# ... with 336,766 more rows, and 11 more variables: arr_delay &lt;dbl&gt;,
#   carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;,
#   air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;
```

---

# select()


```r
flight1 &lt;- select(flights, year:day, tailnum, arr_delay, dep_delay, distance, air_time)
flight1
```

```
# A tibble: 336,776 x 8
    year month   day tailnum arr_delay dep_delay distance air_time
   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;       &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
 1  2013     1     1 N14228         11         2     1400      227
 2  2013     1     1 N24211         20         4     1416      227
 3  2013     1     1 N619AA         33         2     1089      160
 4  2013     1     1 N804JB        -18        -1     1576      183
 5  2013     1     1 N668DN        -25        -6      762      116
 6  2013     1     1 N39463         12        -4      719      150
 7  2013     1     1 N516JB         19        -5     1065      158
 8  2013     1     1 N829AS        -14        -3      229       53
 9  2013     1     1 N593JB         -8        -3      944      140
10  2013     1     1 N3ALAA          8        -2      733      138
# ... with 336,766 more rows
```

---

# filter()


```r
filter(flight1, year %in% c(2012, 2013), 
       month == 1, day &lt; 4)
```

```
# A tibble: 2,699 x 8
    year month   day tailnum arr_delay dep_delay distance air_time
   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;       &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
 1  2013     1     1 N14228         11         2     1400      227
 2  2013     1     1 N24211         20         4     1416      227
 3  2013     1     1 N619AA         33         2     1089      160
 4  2013     1     1 N804JB        -18        -1     1576      183
 5  2013     1     1 N668DN        -25        -6      762      116
 6  2013     1     1 N39463         12        -4      719      150
 7  2013     1     1 N516JB         19        -5     1065      158
 8  2013     1     1 N829AS        -14        -3      229       53
 9  2013     1     1 N593JB         -8        -3      944      140
10  2013     1     1 N3ALAA          8        -2      733      138
# ... with 2,689 more rows
```

---

# sample_n() and sample_frac()


```r
sample_n(flight1, 3) # fixed number
```

```
# A tibble: 3 x 8
   year month   day tailnum arr_delay dep_delay distance air_time
  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;       &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1  2013     8    12 N187DN          8        10     2475      338
2  2013     7     2 N26123        -33         0     2454      300
3  2013     5     7 N402UA          1        17     1167      159
```

```r
sample_frac(flight1, 0.002) # fixed fraction
```

```
# A tibble: 674 x 8
    year month   day tailnum arr_delay dep_delay distance air_time
   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;       &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
 1  2013    12     7 N827AS        -14        -8      228       50
 2  2013     9    11 N11187         NA        -9      645       NA
 3  2013     6     3 N596UA         25        -5     2586      347
 4  2013    11     8 N14568          1        13      569       99
 5  2013    10    18 N520JB        -34        -7     1598      193
 6  2013    10    11 N3AAAA        -15        -6      187       35
 7  2013     6     2 N258WN          2        -2      738      114
 8  2013     7     5 N715SW        -18        -2     1428      197
 9  2013     8     9 N576AA         17        -7      733      119
10  2013     5    14 N3FYAA        -37        -3     1389      186
# ... with 664 more rows
```

---

# arrange()


```r
arrange(flight1, year, month, day)
```

```
# A tibble: 336,776 x 8
    year month   day tailnum arr_delay dep_delay distance air_time
   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;       &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
 1  2013     1     1 N14228         11         2     1400      227
 2  2013     1     1 N24211         20         4     1416      227
 3  2013     1     1 N619AA         33         2     1089      160
 4  2013     1     1 N804JB        -18        -1     1576      183
 5  2013     1     1 N668DN        -25        -6      762      116
 6  2013     1     1 N39463         12        -4      719      150
 7  2013     1     1 N516JB         19        -5     1065      158
 8  2013     1     1 N829AS        -14        -3      229       53
 9  2013     1     1 N593JB         -8        -3      944      140
10  2013     1     1 N3ALAA          8        -2      733      138
# ... with 336,766 more rows
```

---

# arrange(desc())


```r
arrange(flight1, desc(arr_delay))
```

```
# A tibble: 336,776 x 8
    year month   day tailnum arr_delay dep_delay distance air_time
   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;       &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
 1  2013     1     9 N384HA       1272      1301     4983      640
 2  2013     6    15 N504MQ       1127      1137      483       74
 3  2013     1    10 N517MQ       1109      1126      719      111
 4  2013     9    20 N338AA       1007      1014     2586      354
 5  2013     7    22 N665MQ        989      1005      589       96
 6  2013     4    10 N959DL        931       960     1005      139
 7  2013     3    17 N927DA        915       911     1020      167
 8  2013     7    22 N6716C        895       898      762      109
 9  2013    12     5 N5DMAA        878       896     1085      149
10  2013     5     3 N523MQ        875       878      719      112
# ... with 336,766 more rows
```

---

# mutate()


```r
mutate(flight1,
       gain = arr_delay - dep_delay,
       speed = distance / air_time * 60)
```

```
# A tibble: 336,776 x 10
    year month   day tailnum arr_delay dep_delay distance air_time  gain speed
   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;       &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1  2013     1     1 N14228         11         2     1400      227     9  370.
 2  2013     1     1 N24211         20         4     1416      227    16  374.
 3  2013     1     1 N619AA         33         2     1089      160    31  408.
 4  2013     1     1 N804JB        -18        -1     1576      183   -17  517.
 5  2013     1     1 N668DN        -25        -6      762      116   -19  394.
 6  2013     1     1 N39463         12        -4      719      150    16  288.
 7  2013     1     1 N516JB         19        -5     1065      158    24  404.
 8  2013     1     1 N829AS        -14        -3      229       53   -11  259.
 9  2013     1     1 N593JB         -8        -3      944      140    -5  405.
10  2013     1     1 N3ALAA          8        -2      733      138    10  319.
# ... with 336,766 more rows
```

---

# select(mutate())



```r
select(
  mutate(flight1, 
         gain = arr_delay - dep_delay, 
         speed = distance / air_time * 60
  ),
  gain, speed
)
```

```
# A tibble: 336,776 x 2
    gain speed
   &lt;dbl&gt; &lt;dbl&gt;
 1     9  370.
 2    16  374.
 3    31  408.
 4   -17  517.
 5   -19  394.
 6    16  288.
 7    24  404.
 8   -11  259.
 9    -5  405.
10    10  319.
# ... with 336,766 more rows
```

---

# transmute() == select(mutate())


```r
transmute(flight1, 
          gain = arr_delay - dep_delay,
          speed = distance / air_time * 60)
```

```
# A tibble: 336,776 x 2
    gain speed
   &lt;dbl&gt; &lt;dbl&gt;
 1     9  370.
 2    16  374.
 3    31  408.
 4   -17  517.
 5   -19  394.
 6    16  288.
 7    24  404.
 8   -11  259.
 9    -5  405.
10    10  319.
# ... with 336,766 more rows
```

---

# nested structure 

It is very hard to read ...


```r
filter(
  summarise(
    select(
      group_by(flight1, year, month, day),
      arr_delay, dep_delay
    ),
    arr = mean(arr_delay, na.rm = TRUE),
    dep = mean(dep_delay, na.rm = TRUE)
  ),
  arr &gt; 30 | dep &gt; 30
)
```


---

# pip operator %&gt;% 


```r
flight1 %&gt;% 
  mutate(gain = arr_delay - dep_delay, 
         speed = distance / air_time * 60) %&gt;% 
  select(gain, speed)
```

```
# A tibble: 336,776 x 2
    gain speed
   &lt;dbl&gt; &lt;dbl&gt;
 1     9  370.
 2    16  374.
 3    31  408.
 4   -17  517.
 5   -19  394.
 6    16  288.
 7    24  404.
 8   -11  259.
 9    -5  405.
10    10  319.
# ... with 336,766 more rows
```

---

# summarise()


```r
flight1 %&gt;% 
  summarise(delay_mean = mean(dep_delay, na.rm = TRUE), 
            delay_sd = sd(dep_delay, na.rm = TRUE))
```

```
# A tibble: 1 x 2
  delay_mean delay_sd
       &lt;dbl&gt;    &lt;dbl&gt;
1       12.6     40.2
```

---

# group_by() %&gt;% summarise()


```r
flight1 %&gt;%
  group_by(year, month) %&gt;% 
  summarise(delay_mean = mean(dep_delay, na.rm = TRUE), 
            delay_sd = sd(dep_delay, na.rm = TRUE))
```

```
# A tibble: 12 x 4
# Groups:   year [1]
    year month delay_mean delay_sd
   &lt;int&gt; &lt;int&gt;      &lt;dbl&gt;    &lt;dbl&gt;
 1  2013     1      10.0      36.4
 2  2013     2      10.8      36.3
 3  2013     3      13.2      40.1
 4  2013     4      13.9      43.0
 5  2013     5      13.0      39.4
 6  2013     6      20.8      51.5
 7  2013     7      21.7      51.6
 8  2013     8      12.6      37.7
 9  2013     9       6.72     35.6
10  2013    10       6.24     29.7
11  2013    11       5.44     27.6
12  2013    12      16.6      41.9
```


---

# left_join()


```r
flights2 &lt;- flights %&gt;% 
  select(month:day, tailnum, carrier) %&gt;% 
  head(2)

data(airlines, package = "nycflights13")
airlines %&gt;% head(3)
```

```
# A tibble: 3 x 2
  carrier name                  
  &lt;chr&gt;   &lt;chr&gt;                 
1 9E      Endeavor Air Inc.     
2 AA      American Airlines Inc.
3 AS      Alaska Airlines Inc.  
```

---

# left_join()


```r
flights2 %&gt;% 
  left_join(airlines)
```

```
Joining, by = "carrier"
```

```
# A tibble: 2 x 5
  month   day tailnum carrier name                 
  &lt;int&gt; &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;                
1     1     1 N14228  UA      United Air Lines Inc.
2     1     1 N24211  UA      United Air Lines Inc.
```

---

# left_join, right_join()

.pull-left[

```r
(df1 &lt;- tibble(
  x = c(1, 2), y = 2:1))
```

```
# A tibble: 2 x 2
      x     y
  &lt;dbl&gt; &lt;int&gt;
1     1     2
2     2     1
```

```r
(df2 &lt;- tibble(
  x = c(1, 3), a = 10, 
  b = "HI"))
```

```
# A tibble: 2 x 3
      x     a b    
  &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;
1     1    10 HI   
2     3    10 HI   
```
]

--

.pull-right[

```r
df1 %&gt;% left_join(df2)
```

```
Joining, by = "x"
```

```
# A tibble: 2 x 4
      x     y     a b    
  &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;
1     1     2    10 HI   
2     2     1    NA &lt;NA&gt; 
```

```r
df1 %&gt;% right_join(df2)
```

```
Joining, by = "x"
```

```
# A tibble: 2 x 4
      x     y     a b    
  &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;
1     1     2    10 HI   
2     3    NA    10 HI   
```
]

---

# left_join, right_join()


---

# inner_join()


```r
df1 %&gt;% inner_join(df2)
```

```
Joining, by = "x"
```

```
# A tibble: 1 x 4
      x     y     a b    
  &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;
1     1     2    10 HI   
```

---

# Practice



---
class: inverse, center, middle

# tidyr

---

# long vs. wide table

![](figure/long-wide table.jpg)

---

# wide table


```r
student
```

```
   ID math chinese psychology
1   A 51.7       4         59
2   B 27.7      12         59
3   C 40.9      20         61
4   D 64.7      28         61
5   E 41.2      36         59
6   F 12.2      44         59
7   G 63.3      52         61
8   H 55.1      60         61
9   I 36.1      68         59
10  J 49.9      76         59
11  K 41.9      84         61
12  L 70.2      92         61
```

---

# pivot_longer()


```r
student_long &lt;- pivot_longer(student, 
                             cols = c("math", "chinese", "psychology"), # -ID 
                             names_to = "subjects", values_to = "score")
student_long
```

```
# A tibble: 36 x 3
   ID    subjects   score
   &lt;fct&gt; &lt;chr&gt;      &lt;dbl&gt;
 1 A     math        51.7
 2 A     chinese      4  
 3 A     psychology  59  
 4 B     math        27.7
 5 B     chinese     12  
 6 B     psychology  59  
 7 C     math        40.9
 8 C     chinese     20  
 9 C     psychology  61  
10 D     math        64.7
# ... with 26 more rows
```

---

# pivot_wider()


```r
student_wide &lt;- pivot_wider(student_long,
                            names_from = "subjects", values_from = "score")
student_wide
```

```
# A tibble: 12 x 4
   ID     math chinese psychology
   &lt;fct&gt; &lt;dbl&gt;   &lt;dbl&gt;      &lt;dbl&gt;
 1 A      51.7       4         59
 2 B      27.7      12         59
 3 C      40.9      20         61
 4 D      64.7      28         61
 5 E      41.2      36         59
 6 F      12.2      44         59
 7 G      63.3      52         61
 8 H      55.1      60         61
 9 I      36.1      68         59
10 J      49.9      76         59
11 K      41.9      84         61
12 L      70.2      92         61
```

---

# Practice

請對 `ebg` 這筆資料，利用 `boxplot(y~group, data)` 畫出，依照不同 Money 種類 (group: p1Cash, p1Stock, p1TotalAsset) 的價格分佈。

--


```r
ebg_long &lt;- pivot_longer(ebg, cols = c("p1Cash", "p1Stock", "p1TotalAsset"),
                         names_to = "money", values_to = "value")
boxplot(value ~ money, data = ebg_long)
```

![](data-manipulate_files/figure-html/unnamed-chunk-27-1.png)&lt;!-- --&gt;

---
class: inverse, center, middle

# ggplot2

---

# [Cheetsheet](https://www.rstudio.org/links/data_transformation_cheat_sheet)

![](data-transformation.jpg)

---

# [Cheetsheet](https://www.rstudio.org/links/data_transformation_cheat_sheet)


![](data-transformation 2.jpg)

---

# RStudio cheetsheets 

Link: &lt;https://rstudio.com/resources/cheatsheets/&gt;

In RStudio: Help &gt; Cheetsheets &gt; ...

---

# References

- `vignette("dplyr", package = "dplyr")`
- `vignette("", package = "dplyr")`
- ``
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script src="macros.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
