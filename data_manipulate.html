<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
  <head>
    <title>Data Manipulation and Plot in R</title>
    <meta charset="utf-8" />
    <meta name="author" content="林子堯" />
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link rel="stylesheet" href="my-theme.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Data Manipulation and Plot in R
## tidyr, dplyr and ggplot2
### 林子堯
### 2020/03/28 Sat.

---



# Download first

Short url: &lt;https://bit.ly/39a7RCI&gt;
.center[
![](figure/qr.ioi.tw.png)
]


```r
# install.packages(tidyverse)
library(tidyverse)
```

---

# Outline

- introduction
- data.frame
- dplyr
- tidyr
- ggplot2

---

# Motivation

Data preprocessing takes 50-80% of your time in data analysis

Goal of Data Preprocessing  
- ake data suitable to use with a particular piece of software (i.e. R, - Python)  
- Reveal important information  
- Extract variables to analyze

---

# Hadley Wickham

- The Man Who Revolutionized R
- The Committee of Presidents of Statistical Societies Awards
- tidyverse

![](figure/HadleyWickham-R.jpg)

---

![](figure/ChartHadley.png)

---

![](figure/package download.png)

---

# R packages for data science

## [tidyverse](https://www.tidyverse.org/)

![](figure/tidyverse_data_science.png)

---
class: inverse, center, middle

# data.frame


---

# data.frame create


```r
student &lt;- data.frame(ID = LETTERS[1:12], 
                      math = round(rnorm(12, 50, 15), 1),
                      chinese = seq(4, 92, length.out = 12))
class(student)
```

```
## [1] "data.frame"
```

```r
student
```

```
##    ID math chinese
## 1   A 48.7       4
## 2   B 68.2      12
## 3   C 89.1      20
## 4   D 49.8      28
## 5   E 60.0      36
## 6   F 48.5      44
## 7   G 68.6      52
## 8   H 61.3      60
## 9   I 39.2      68
## 10  J 75.0      76
## 11  K 42.6      84
## 12  L 70.4      92
```

--

load data

```r
ebg &lt;- read.csv("~/Documents/R/EBG/converted data/001_b_1110_1_1_p1.csv", 
                fileEncoding = "UTF-8")
View(ebg)
```

```
## Warning in system2("/usr/bin/otool", c("-L", shQuote(DSO)), stdout = TRUE):
## running command ''/usr/bin/otool' -L '/Library/Frameworks/R.framework/
## Resources/modules/R_de.so'' had status 1
```

```r
class(ebg)
```

```
## [1] "data.frame"
```

---

# data.frame read


```r
# []
ebg[1]
```

```
##     Trials
## 1        1
## 2        2
## 3        3
## 4        4
## 5        5
## 6        6
## 7        7
## 8        8
## 9        9
## 10      10
## 11      11
## 12      12
## 13      13
## 14      14
## 15      15
## 16      16
## 17      17
## 18      18
## 19      19
## 20      20
## 21      21
## 22      22
## 23      23
## 24      24
## 25      25
## 26      26
## 27      27
## 28      28
## 29      29
## 30      30
## 31      31
## 32      32
## 33      33
## 34      34
## 35      35
## 36      36
## 37      37
## 38      38
## 39      39
## 40      40
## 41      41
## 42      42
## 43      43
## 44      44
## 45      45
## 46      46
## 47      47
## 48      48
## 49      49
## 50      50
## 51      51
## 52      52
## 53      53
## 54      54
## 55      55
## 56      56
## 57      57
## 58      58
## 59      59
## 60      60
## 61      61
## 62      62
## 63      63
## 64      64
## 65      65
## 66      66
## 67      67
## 68      68
## 69      69
## 70      70
## 71      71
## 72      72
## 73      73
## 74      74
## 75      75
## 76      76
## 77      77
## 78      78
## 79      79
## 80      80
## 81      81
## 82      82
## 83      83
## 84      84
## 85      85
## 86      86
## 87      87
## 88      88
## 89      89
## 90      90
## 91      91
## 92      92
## 93      93
## 94      94
## 95      95
## 96      96
## 97      97
## 98      98
## 99      99
## 100    100
## 101    101
```

```r
ebg["p1Cash"]
```

```
##     p1Cash
## 1    10000
## 2     9900
## 3    10005
## 4     9900
## 5    10011
## 6    10011
## 7     9908
## 8     9805
## 9     9805
## 10    9705
## 11    9810
## 12    9710
## 13    9710
## 14    9613
## 15    9715
## 16    9715
## 17    9715
## 18    9618
## 19    9521
## 20    9618
## 21    9618
## 22    9714
## 23    9810
## 24    9718
## 25    9820
## 26    9820
## 27    9725
## 28    9830
## 29    9830
## 30    9733
## 31    9733
## 32    9837
## 33    9837
## 34    9934
## 35    9837
## 36    9740
## 37    9633
## 38    9526
## 39    9412
## 40    9533
## 41    9415
## 42    9541
## 43    9664
## 44    9544
## 45    9672
## 46    9547
## 47    9414
## 48    9273
## 49    9429
## 50    9578
## 51    9727
## 52    9876
## 53   10021
## 54   10166
## 55   10166
## 56   10166
## 57   10166
## 58   10036
## 59   10174
## 60   10312
## 61   10312
## 62   10444
## 63   10318
## 64   10188
## 65   10054
## 66   10195
## 67   10068
## 68    9937
## 69    9799
## 70    9661
## 71    9518
## 72    9370
## 73    9217
## 74    9059
## 75    9222
## 76    9377
## 77    9525
## 78    9666
## 79    9532
## 80    9671
## 81    9804
## 82    9931
## 83   10052
## 84   10167
## 85   10277
## 86   10382
## 87   10482
## 88   10482
## 89   10482
## 90   10387
## 91   10485
## 92   10579
## 93   10669
## 94   10755
## 95   10837
## 96   10915
## 97   10990
## 98   11062
## 99   11131
## 100  11131
## 101  11131
```

```r
# [,]
ebg[1, 3]
```

```
## [1] 100
```

```r
ebg[1:10, 2:3]
```

```
##    MarketCondition StockPrice
## 1                1        100
## 2                1        105
## 3                1        105
## 4                1        111
## 5                1        106
## 6                1        103
## 7                1        103
## 8                1        103
## 9                1        100
## 10               1        105
```

```r
# [[]]
ebg[[1]]
```

```
##   [1]   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17
##  [18]  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34
##  [35]  35  36  37  38  39  40  41  42  43  44  45  46  47  48  49  50  51
##  [52]  52  53  54  55  56  57  58  59  60  61  62  63  64  65  66  67  68
##  [69]  69  70  71  72  73  74  75  76  77  78  79  80  81  82  83  84  85
##  [86]  86  87  88  89  90  91  92  93  94  95  96  97  98  99 100 101
```

```r
# $
ebg$StockPrice
```

```
##   [1] 100 105 105 111 106 103 103 103 100 105 100 100  97 102  97 100  97
##  [18]  97  97  93  96  96  92 102  97  95 105 100  97 107 104  99  97  97
##  [35]  97 107 107 114 121 118 126 123 120 128 125 133 141 156 149 149 149
##  [52] 145 145 138 138 134 130 138 138 132 132 126 130 134 141 127 131 138
##  [69] 138 143 148 153 158 163 155 148 141 134 139 133 127 121 115 110 105
##  [86] 100  95  95  95  98  94  90  86  82  78  75  72  69  66  66  68
```

```r
ebg$p1Decision[61:100]
```

```
##  [1] sell     buy      buy      buy      sell     buy      buy     
##  [8] buy      buy      buy      buy      buy      buy      sell    
## [15] sell     sell     sell     buy      sell     sell     sell    
## [22] sell     sell     sell     sell     sell     no trade no trade
## [29] buy      sell     sell     sell     sell     sell     sell    
## [36] sell     sell     sell     no trade no trade
## Levels:  buy no trade sell
```

```r
typeof(ebg)
```

```
## [1] "list"
```

---

# data.frame update


```r
student$psychology &lt;- rep(c(59, 61), each = 2, times = 3)
student
```

```
##    ID math chinese psychology
## 1   A 48.7       4         59
## 2   B 68.2      12         59
## 3   C 89.1      20         61
## 4   D 49.8      28         61
## 5   E 60.0      36         59
## 6   F 48.5      44         59
## 7   G 68.6      52         61
## 8   H 61.3      60         61
## 9   I 39.2      68         59
## 10  J 75.0      76         59
## 11  K 42.6      84         61
## 12  L 70.4      92         61
```


---
class: inverse, center, middle

# dplyr

---

# tibble


```r
# install.packages("nycflights13")
data(flights, package = "nycflights13")
flights
```

```
## # A tibble: 336,776 x 19
##     year month   day dep_time sched_dep_time dep_delay arr_time
##    &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;
##  1  2013     1     1      517            515         2      830
##  2  2013     1     1      533            529         4      850
##  3  2013     1     1      542            540         2      923
##  4  2013     1     1      544            545        -1     1004
##  5  2013     1     1      554            600        -6      812
##  6  2013     1     1      554            558        -4      740
##  7  2013     1     1      555            600        -5      913
##  8  2013     1     1      557            600        -3      709
##  9  2013     1     1      557            600        -3      838
## 10  2013     1     1      558            600        -2      753
## # … with 336,766 more rows, and 12 more variables: sched_arr_time &lt;int&gt;,
## #   arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;,
## #   origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;,
## #   minute &lt;dbl&gt;, time_hour &lt;dttm&gt;
```

---

# select()


```r
select(flights, year, month, day) # select(flights, year:day)
```

```
## # A tibble: 336,776 x 3
##     year month   day
##    &lt;int&gt; &lt;int&gt; &lt;int&gt;
##  1  2013     1     1
##  2  2013     1     1
##  3  2013     1     1
##  4  2013     1     1
##  5  2013     1     1
##  6  2013     1     1
##  7  2013     1     1
##  8  2013     1     1
##  9  2013     1     1
## 10  2013     1     1
## # … with 336,766 more rows
```

---

# filter()


```r
filter(flights, year %in% c(2012, 2013), month == 1, day &lt; 4)
```

```
## # A tibble: 2,699 x 19
##     year month   day dep_time sched_dep_time dep_delay arr_time
##    &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;
##  1  2013     1     1      517            515         2      830
##  2  2013     1     1      533            529         4      850
##  3  2013     1     1      542            540         2      923
##  4  2013     1     1      544            545        -1     1004
##  5  2013     1     1      554            600        -6      812
##  6  2013     1     1      554            558        -4      740
##  7  2013     1     1      555            600        -5      913
##  8  2013     1     1      557            600        -3      709
##  9  2013     1     1      557            600        -3      838
## 10  2013     1     1      558            600        -2      753
## # … with 2,689 more rows, and 12 more variables: sched_arr_time &lt;int&gt;,
## #   arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;,
## #   origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;,
## #   minute &lt;dbl&gt;, time_hour &lt;dttm&gt;
```

---

# arrange()


```r
arrange(flights, year, month, day)
```

```
## # A tibble: 336,776 x 19
##     year month   day dep_time sched_dep_time dep_delay arr_time
##    &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;
##  1  2013     1     1      517            515         2      830
##  2  2013     1     1      533            529         4      850
##  3  2013     1     1      542            540         2      923
##  4  2013     1     1      544            545        -1     1004
##  5  2013     1     1      554            600        -6      812
##  6  2013     1     1      554            558        -4      740
##  7  2013     1     1      555            600        -5      913
##  8  2013     1     1      557            600        -3      709
##  9  2013     1     1      557            600        -3      838
## 10  2013     1     1      558            600        -2      753
## # … with 336,766 more rows, and 12 more variables: sched_arr_time &lt;int&gt;,
## #   arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;,
## #   origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;,
## #   minute &lt;dbl&gt;, time_hour &lt;dttm&gt;
```

---

# arrange(desc())


```r
arrange(flights, desc(arr_delay))
```

```
## # A tibble: 336,776 x 19
##     year month   day dep_time sched_dep_time dep_delay arr_time
##    &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;
##  1  2013     1     9      641            900      1301     1242
##  2  2013     6    15     1432           1935      1137     1607
##  3  2013     1    10     1121           1635      1126     1239
##  4  2013     9    20     1139           1845      1014     1457
##  5  2013     7    22      845           1600      1005     1044
##  6  2013     4    10     1100           1900       960     1342
##  7  2013     3    17     2321            810       911      135
##  8  2013     7    22     2257            759       898      121
##  9  2013    12     5      756           1700       896     1058
## 10  2013     5     3     1133           2055       878     1250
## # … with 336,766 more rows, and 12 more variables: sched_arr_time &lt;int&gt;,
## #   arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;,
## #   origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;,
## #   minute &lt;dbl&gt;, time_hour &lt;dttm&gt;
```

---

# mutate()


```r
mutate(flights,
       gain = arr_delay - dep_delay,
       speed = distance / air_time * 60)
```

```
## # A tibble: 336,776 x 21
##     year month   day dep_time sched_dep_time dep_delay arr_time
##    &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;
##  1  2013     1     1      517            515         2      830
##  2  2013     1     1      533            529         4      850
##  3  2013     1     1      542            540         2      923
##  4  2013     1     1      544            545        -1     1004
##  5  2013     1     1      554            600        -6      812
##  6  2013     1     1      554            558        -4      740
##  7  2013     1     1      555            600        -5      913
##  8  2013     1     1      557            600        -3      709
##  9  2013     1     1      557            600        -3      838
## 10  2013     1     1      558            600        -2      753
## # … with 336,766 more rows, and 14 more variables: sched_arr_time &lt;int&gt;,
## #   arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;,
## #   origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;,
## #   minute &lt;dbl&gt;, time_hour &lt;dttm&gt;, gain &lt;dbl&gt;, speed &lt;dbl&gt;
```

---

# transmute() = select(mutate())


```r
# select(mutate(flights, gain = arr_delay - dep_delay, speed = distance / air_time * 60),
#        gain, speed)
transmute(flights, 
          gain = arr_delay - dep_delay,
          speed = distance / air_time * 60)
```

```
## # A tibble: 336,776 x 2
##     gain speed
##    &lt;dbl&gt; &lt;dbl&gt;
##  1     9  370.
##  2    16  374.
##  3    31  408.
##  4   -17  517.
##  5   -19  394.
##  6    16  288.
##  7    24  404.
##  8   -11  259.
##  9    -5  405.
## 10    10  319.
## # … with 336,766 more rows
```


---

# summarise()


```r
summarise(flights, 
          delay_mean = mean(dep_delay, na.rm = TRUE), 
          delay_sd = sd(dep_delay, na.rm = TRUE))
```

```
## # A tibble: 1 x 2
##   delay_mean delay_sd
##        &lt;dbl&gt;    &lt;dbl&gt;
## 1       12.6     40.2
```

---
# pip operator %&gt;% 

---
# group_by()
---
# group_by() %&gt;% summarise()
---
# left_join(), right_join(), &amp; inner_join()



---
class: inverse, center, middle

# tidyr

---

# long vs. wide table

![](figure/long-wide table.jpg)

---

# wide table


```r
student
```

```
##    ID math chinese psychology
## 1   A 48.7       4         59
## 2   B 68.2      12         59
## 3   C 89.1      20         61
## 4   D 49.8      28         61
## 5   E 60.0      36         59
## 6   F 48.5      44         59
## 7   G 68.6      52         61
## 8   H 61.3      60         61
## 9   I 39.2      68         59
## 10  J 75.0      76         59
## 11  K 42.6      84         61
## 12  L 70.4      92         61
```

---

# pivot_longer()


```r
student_long &lt;- pivot_longer(student, 
                             cols = c("math", "chinese", "psychology"), # -ID 
                             names_to = "subjects", values_to = "score")
student_long
```

```
## # A tibble: 36 x 3
##    ID    subjects   score
##    &lt;fct&gt; &lt;chr&gt;      &lt;dbl&gt;
##  1 A     math        48.7
##  2 A     chinese      4  
##  3 A     psychology  59  
##  4 B     math        68.2
##  5 B     chinese     12  
##  6 B     psychology  59  
##  7 C     math        89.1
##  8 C     chinese     20  
##  9 C     psychology  61  
## 10 D     math        49.8
## # … with 26 more rows
```

---

# pivot_wider()


```r
student_wide &lt;- pivot_wider(student_long,
                            names_from = "subjects", values_from = "score")
student_wide
```

```
## # A tibble: 12 x 4
##    ID     math chinese psychology
##    &lt;fct&gt; &lt;dbl&gt;   &lt;dbl&gt;      &lt;dbl&gt;
##  1 A      48.7       4         59
##  2 B      68.2      12         59
##  3 C      89.1      20         61
##  4 D      49.8      28         61
##  5 E      60        36         59
##  6 F      48.5      44         59
##  7 G      68.6      52         61
##  8 H      61.3      60         61
##  9 I      39.2      68         59
## 10 J      75        76         59
## 11 K      42.6      84         61
## 12 L      70.4      92         61
```

---

# Practice

請對 `ebg` 這筆資料，利用 `boxplot(y~group, data)` 畫出，依照不同 Money 種類 (group: p1Cash, p1Stock, p1TotalAsset) 的價格分佈。

--


```r
ebg_long &lt;- pivot_longer(ebg, cols = c("p1Cash", "p1Stock", "p1TotalAsset"),
                         names_to = "money", values_to = "value")
boxplot(value ~ money, data = ebg_long)
```

![](data_manipulate_files/figure-html/unnamed-chunk-17-1.png)&lt;!-- --&gt;

---
class: inverse, center, middle

# ggplot2

---

# [Cheetsheet](https://www.rstudio.org/links/data_transformation_cheat_sheet)

![](data-transformation.jpg)

---

# [Cheetsheet](https://www.rstudio.org/links/data_transformation_cheat_sheet)


![](data-transformation 2.jpg)

---

# RStudio cheetsheets 

Link: &lt;https://rstudio.com/resources/cheatsheets/&gt;

In RStudio: Help &gt; Cheetsheets &gt; ...

---

# References
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();</script>

<script>
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
